{% extends "base.html" %}

{% block title %}Batch Processing - AI Image Analyzer{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-layer-group me-2"></i>Batch Image Processing
                    </h3>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Upload multiple images at once for batch analysis. Perfect for processing large collections of items.
                    </p>
                    
                    <!-- Batch Upload Form -->
                    <form id="batchUploadForm" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="batchFiles" class="form-label">
                                <i class="fas fa-images me-2"></i>Select Multiple Images
                            </label>
                            <input type="file" class="form-control" id="batchFiles" name="files" multiple 
                                   accept="image/png,image/jpg,image/jpeg,image/gif,image/webp">
                            <div class="form-text">You can select up to 10 images at once. Supported formats: PNG, JPG, JPEG, GIF, WEBP</div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="processBatchBtn">
                                <i class="fas fa-magic me-2"></i>Process All Images
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress Section -->
                    <div id="progressSection" class="mt-4" style="display: none;">
                        <h5><i class="fas fa-tasks me-2"></i>Processing Progress</h5>
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                        <div class="text-center">
                            <span id="progressText">0 / 0 images processed</span>
                        </div>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="resultsSection" class="mt-4" style="display: none;">
                        <h5><i class="fas fa-chart-bar me-2"></i>Batch Results</h5>
                        <div id="batchResults"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Individual Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Analysis Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('batchUploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const files = document.getElementById('batchFiles').files;
    if (files.length === 0) {
        alert('Please select at least one image file.');
        return;
    }
    
    if (files.length > 10) {
        alert('Please select no more than 10 images at once.');
        return;
    }
    
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    // Show progress section
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('processBatchBtn').disabled = true;
    
    const results = [];
    const totalFiles = files.length;
    
    for (let i = 0; i < files.length; i++) {
        try {
            // Update progress
            const progress = ((i + 1) / totalFiles) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${i + 1} / ${totalFiles} images processed`;
            
            // Process individual file
            const fileFormData = new FormData();
            fileFormData.append('file', files[i]);
            
            const response = await fetch('/api/analyze', {
                method: 'POST',
                body: fileFormData
            });
            
            if (response.ok) {
                const result = await response.json();
                result.filename = files[i].name;
                results.push(result);
            } else {
                const error = await response.json();
                results.push({
                    filename: files[i].name,
                    error: error.error || 'Processing failed'
                });
            }
            
        } catch (error) {
            results.push({
                filename: files[i].name,
                error: 'Network error: ' + error.message
            });
        }
    }
    
    // Hide progress and show results
    document.getElementById('progressSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'block';
    document.getElementById('processBatchBtn').disabled = false;
    
    // Display results
    displayBatchResults(results);
});

function displayBatchResults(results) {
    const resultsContainer = document.getElementById('batchResults');
    resultsContainer.innerHTML = '';
    
    results.forEach((result, index) => {
        const resultCard = document.createElement('div');
        resultCard.className = 'card mb-3';
        
        if (result.error) {
            resultCard.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>${result.filename}
                            </h6>
                            <p class="card-text text-muted">${result.error}</p>
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultCard.innerHTML = `
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <img src="/${result.processed_image}" class="img-fluid rounded" alt="Processed image">
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title">${result.filename}</h6>
                                    <span class="badge bg-primary me-2">${result.category}</span>
                                    <span class="badge bg-success">${result.confidence}% confidence</span>
                                    <p class="card-text mt-2">${result.analysis.substring(0, 200)}...</p>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" onclick="showDetailedResult(${index})">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        resultsContainer.appendChild(resultCard);
    });
    
    // Store results globally for modal display
    window.batchResults = results;
}

function showDetailedResult(index) {
    const result = window.batchResults[index];
    if (!result || result.error) return;
    
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Original Image</h6>
                <img src="/${result.original_image}" class="img-fluid rounded mb-3" alt="Original image">
                <h6>Processed Image</h6>
                <img src="/${result.processed_image}" class="img-fluid rounded" alt="Processed image">
            </div>
            <div class="col-md-6">
                <h6>Analysis</h6>
                <p class="text-muted">${result.analysis}</p>
                
                <h6 class="mt-3">DIY Ideas</h6>
                <ul class="list-unstyled">
                    ${result.recommendations.diy_ideas.map(idea => `<li><i class="fas fa-lightbulb text-warning me-2"></i>${idea}</li>`).join('')}
                </ul>
                
                <h6 class="mt-3">Monetization</h6>
                <ul class="list-unstyled">
                    ${result.recommendations.monetization.map(item => `<li><i class="fas fa-dollar-sign text-success me-2"></i>${item}</li>`).join('')}
                </ul>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    modal.show();
}
</script>
{% endblock %}
